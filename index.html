<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client-side Hash Calculator</title>
    <style>
      #uri {
          width: 400px;
      }
    </style>
    <script>
    function sha256buffer(buffer) {
      return crypto.subtle.digest("SHA-256", buffer);
    };

    // From https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto/digest
    function hex(buffer) {
      var hexCodes = [];
      var view = new DataView(buffer);
      for (var i = 0; i < view.byteLength; i += 4) {
        // Using getUint32 reduces the number of iterations needed (we process 4 bytes each time)
        var value = view.getUint32(i)
        // toString(16) will give the hex representation of the number without padding
        var stringValue = value.toString(16)
        // We use concatenation and slice for padding
        var padding = '00000000'
        var paddedValue = (padding + stringValue).slice(-padding.length)
        hexCodes.push(paddedValue);
      }
      return hexCodes.join("");
    };

    function getRemoteResource(uri, success, error) {
      var xhr = new XMLHttpRequest();
      xhr.responseType = 'arraybuffer';
      xhr.addEventListener('load', function(event) {
        success(this.response);
      });
      xhr.addEventListener('error', error);
      xhr.open('GET', uri);
      xhr.send();
    };

    // Print the hash of a local file
    window.addEventListener("load", function () {
      document.getElementById('fileinput').addEventListener('change', function(){
        var file = this.files[0];

        var fileReader = new FileReader();
        fileReader.onload = function() {
          sha256buffer(this.result)
          .then(function(hashArray) {
            var sha256 = hex(hashArray);
            document.getElementById('sha256-hash').innerText = sha256;
          }).catch(function(err) {
            document.getElementById('errors').innerText = 'Error hashing file';
          });   
        };

        fileReader.readAsArrayBuffer(file);
      });

      // Fetch the remote resource upon submit
      var form = document.getElementById('uri-form');

      form.addEventListener("submit", function (event) {
        event.preventDefault();
        var uri = document.getElementById('uri').value;

        var success = function(buffer) {
          sha256buffer(buffer)
          .then(function(hashArray) {
            var sha256 = hex(hashArray);
            document.getElementById('sha256-hash').innerHTML =
              '<em>SHA-256 Hash</em><br>' + sha256;
          }).catch(function(err) {
            document.getElementById('errors').innerText = 'Error hashing file';
          });
        };
        var error = function() {
          document.getElementById('errors').innerText =
            'Problem fetching ' + uri + '. If this URL is valid, the remote '
            + 'server probably does not allow cross-domain requests.';
        };
        getRemoteResource(uri, success, error);
      });
     
    });

    </script>
  </head>
  <body>
    <form action="" id="uri-form" name="uri-form">
      <p>Enter URL <input id="uri"></input>
      <input type="submit" value="Submit"></p>
    </form>
    <p>&lt; or &gt;
    <p>Choose file <input type="file" id="fileinput" />
    <br>
    <p id="sha256-hash"></p>
    <p id="errors"></p>
  </body>
</html>
